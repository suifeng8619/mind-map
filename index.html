<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>思维导图</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mind-elixir/dist/style.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
    }

    .toolbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 50px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      padding: 0 20px;
      gap: 10px;
      z-index: 100;
    }

    .toolbar h1 {
      font-size: 18px;
      color: #333;
      margin-right: 30px;
    }

    .toolbar button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #4f46e5;
      color: white;
    }

    .btn-primary:hover {
      background: #4338ca;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #374151;
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-warning {
      background: #f59e0b;
      color: white;
    }

    .btn-warning:hover {
      background: #d97706;
    }

    #map {
      position: fixed;
      top: 50px;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100%;
      height: calc(100vh - 50px);
    }

    .tips {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.8;
      z-index: 100;
    }

    .tips kbd {
      background: rgba(255,255,255,0.2);
      padding: 2px 6px;
      border-radius: 4px;
      margin: 0 2px;
    }

    /* 弹窗样式 */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }

    .modal {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 500px;
      width: 90%;
    }

    .modal h2 {
      margin-bottom: 20px;
      color: #333;
      font-size: 20px;
    }

    .modal p {
      color: #666;
      margin-bottom: 15px;
      line-height: 1.6;
    }

    .modal input, .modal textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 15px;
      transition: border-color 0.2s;
      font-family: monospace;
    }

    .modal input:focus, .modal textarea:focus {
      outline: none;
      border-color: #4f46e5;
    }

    .modal textarea {
      height: 100px;
      resize: none;
    }

    .share-code {
      background: #f3f4f6;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 20px;
    }

    .share-code .code {
      font-size: 24px;
      font-weight: bold;
      color: #4f46e5;
      letter-spacing: 2px;
      font-family: 'Courier New', monospace;
      word-break: break-all;
    }

    .share-code .hint {
      font-size: 13px;
      color: #888;
      margin-top: 10px;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .modal-buttons button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .hidden {
      display: none !important;
    }

    .toolbar-divider {
      width: 1px;
      height: 24px;
      background: #e5e7eb;
      margin: 0 5px;
    }

    .toast {
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      z-index: 300;
      animation: fadeInOut 2.5s ease;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
      15% { opacity: 1; transform: translateX(-50%) translateY(0); }
      85% { opacity: 1; transform: translateX(-50%) translateY(0); }
      100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .status-bar {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 8px 15px;
      border-radius: 6px;
      font-size: 12px;
      z-index: 100;
    }

    .status-bar.saved {
      background: rgba(16, 185, 129, 0.9);
    }

    .status-bar.saving {
      background: rgba(245, 158, 11, 0.9);
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <h1>思维导图</h1>
    <button class="btn-primary" id="btn-add-child">添加子节点</button>
    <button class="btn-primary" id="btn-add-sibling">添加同级节点</button>
    <button class="btn-secondary" id="btn-remove">删除节点</button>
    <div class="toolbar-divider"></div>
    <button class="btn-success" id="btn-save-cloud">保存并分享</button>
    <button class="btn-warning" id="btn-load-cloud">导入数据</button>
    <div class="toolbar-divider"></div>
    <button class="btn-secondary" id="btn-export-png">导出 PNG</button>
    <button class="btn-secondary" id="btn-export-json">导出 JSON</button>
    <button class="btn-secondary" id="btn-clear">清空重置</button>
  </div>

  <div id="map"></div>

  <div class="tips">
    <strong>快捷键：</strong><br>
    <kbd>Tab</kbd> 添加子节点 &nbsp;
    <kbd>Enter</kbd> 添加同级节点<br>
    <kbd>Delete</kbd> 删除节点 &nbsp;
    <kbd>双击</kbd> 编辑节点
  </div>

  <div class="status-bar" id="status-bar">自动保存已开启</div>

  <!-- 保存成功弹窗 -->
  <div class="modal-overlay hidden" id="save-modal">
    <div class="modal">
      <h2>保存成功</h2>
      <p>复制以下链接，在任意设备打开即可恢复数据：</p>
      <textarea id="share-url-display" readonly></textarea>
      <div class="modal-buttons">
        <button class="btn-success" id="btn-copy-url">复制链接</button>
        <button class="btn-primary" id="btn-close-save-modal">确定</button>
      </div>
    </div>
  </div>

  <!-- 加载弹窗 -->
  <div class="modal-overlay hidden" id="load-modal">
    <div class="modal">
      <h2>导入数据</h2>
      <p>粘贴之前保存的分享链接，或直接粘贴 JSON 数据：</p>
      <textarea id="load-data-input" placeholder="粘贴链接或 JSON 数据..."></textarea>
      <div class="modal-buttons">
        <button class="btn-secondary" id="btn-cancel-load">取消</button>
        <button class="btn-primary" id="btn-confirm-load">导入</button>
      </div>
    </div>
  </div>

  <!-- Supabase 客户端 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script type="module">
    import MindElixir from 'https://cdn.jsdelivr.net/npm/mind-elixir/dist/MindElixir.js'

    // Supabase 配置
    const SUPABASE_URL = 'https://memikwsglxuyjfwfbmli.supabase.co'
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1lbWlrd3NnbHh1eWpmd2ZibWxpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MzExMTYsImV4cCI6MjA4MDIwNzExNn0.hkKDRt2SWO9e1vetVwESfIn2lOwZ_8bON6bAIjq-OsE'
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

    // 生成短 ID (6位随机字符)
    function generateShortId() {
      const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'
      let id = ''
      for (let i = 0; i < 6; i++) {
        id += chars.charAt(Math.floor(Math.random() * chars.length))
      }
      return id
    }

    // 显示 toast 提示
    function showToast(message, duration = 2500) {
      const existing = document.querySelector('.toast')
      if (existing) existing.remove()

      const toast = document.createElement('div')
      toast.className = 'toast'
      toast.textContent = message
      document.body.appendChild(toast)
      setTimeout(() => toast.remove(), duration)
    }

    // 更新状态栏
    function updateStatus(text, type = '') {
      const bar = document.getElementById('status-bar')
      bar.textContent = text
      bar.className = 'status-bar ' + type
    }

    // 保存到 Supabase
    async function saveToCloud(data, existingId = null) {
      try {
        const id = existingId || generateShortId()

        if (existingId) {
          // 更新现有记录
          const { error } = await supabase
            .from('mindmaps')
            .update({ data: data })
            .eq('id', id)

          if (error) throw error
        } else {
          // 插入新记录
          const { error } = await supabase
            .from('mindmaps')
            .insert({ id: id, data: data })

          if (error) {
            // 如果 ID 冲突，生成新 ID 重试
            if (error.code === '23505') {
              return saveToCloud(data, null)
            }
            throw error
          }
        }

        return id
      } catch (e) {
        console.error('云端保存失败:', e)
        return null
      }
    }

    // 从 Supabase 加载
    async function loadFromCloud(id) {
      try {
        const { data, error } = await supabase
          .from('mindmaps')
          .select('data')
          .eq('id', id)
          .single()

        if (error) throw error
        return data?.data || null
      } catch (e) {
        console.error('云端加载失败:', e)
        return null
      }
    }

    // 生成分享 URL（使用短 ID）
    function generateShareUrl(id) {
      const baseUrl = window.location.origin + window.location.pathname
      return `${baseUrl}?id=${id}`
    }

    // 从 URL 解析 ID
    function parseUrlId() {
      const url = new URL(window.location.href)
      return url.searchParams.get('id')
    }

    // 解析用户输入（链接、ID 或 JSON）
    function parseUserInput(input) {
      input = input.trim()

      // 尝试解析为 URL
      try {
        const url = new URL(input)
        const id = url.searchParams.get('id')
        if (id) {
          return { cloudId: id }
        }
      } catch (e) {
        // 不是有效 URL
      }

      // 尝试解析为 JSON
      try {
        const data = JSON.parse(input)
        if (data.nodeData) {
          return { mindmapData: data }
        }
      } catch (e) {
        // 不是有效 JSON
      }

      // 如果是 6 位字符，可能是短 ID
      if (/^[a-zA-Z0-9]{6}$/.test(input)) {
        return { cloudId: input }
      }

      return null
    }

    // 初始化 Mind Elixir
    const mind = new MindElixir({
      el: '#map',
      direction: MindElixir.SIDE,
      draggable: true,
      contextMenu: true,
      toolBar: true,
      nodeMenu: true,
      keypress: true,
    })

    // 默认数据
    const defaultData = {
      nodeData: {
        id: 'root',
        topic: '我的思维导图',
        children: [
          {
            id: 'sub1',
            topic: '主题 1',
            children: [
              { id: 'sub1-1', topic: '子主题 1-1' },
              { id: 'sub1-2', topic: '子主题 1-2' },
            ]
          },
          {
            id: 'sub2',
            topic: '主题 2',
            children: [
              { id: 'sub2-1', topic: '子主题 2-1' },
            ]
          },
          {
            id: 'sub3',
            topic: '主题 3',
          },
        ]
      }
    }

    // 当前文档的云端 ID
    let currentCloudId = localStorage.getItem('mindmap-cloud-id') || null

    // 初始化数据
    async function initializeData() {
      // 1. 先检查 URL 参数
      const urlId = parseUrlId()

      if (urlId) {
        showToast('正在从云端加载...')
        const cloudData = await loadFromCloud(urlId)
        if (cloudData) {
          mind.init(cloudData)
          currentCloudId = urlId
          localStorage.setItem('mindmap-data', JSON.stringify(cloudData))
          localStorage.setItem('mindmap-cloud-id', urlId)
          showToast('云端数据加载成功')
          updateStatus(`已加载云端数据 (ID: ${urlId})`, 'saved')
          return
        } else {
          showToast('云端数据加载失败，使用本地数据')
        }
      }

      // 2. 检查 localStorage
      const saved = localStorage.getItem('mindmap-data')
      if (saved) {
        try {
          mind.init(JSON.parse(saved))
          if (currentCloudId) {
            updateStatus(`已加载本地数据 (云端 ID: ${currentCloudId})`, 'saved')
          } else {
            updateStatus('已加载本地数据', 'saved')
          }
          return
        } catch (e) {
          console.error('localStorage 数据解析失败', e)
        }
      }

      // 3. 使用默认数据
      mind.init(defaultData)
    }

    // 执行初始化
    initializeData()

    // 绑定按钮事件
    document.getElementById('btn-add-child').addEventListener('click', () => {
      mind.addChild()
    })

    document.getElementById('btn-add-sibling').addEventListener('click', () => {
      mind.insertSibling()
    })

    document.getElementById('btn-remove').addEventListener('click', () => {
      mind.removeNode()
    })

    // 保存并分享
    document.getElementById('btn-save-cloud').addEventListener('click', async () => {
      const data = mind.getData()

      updateStatus('正在保存到云端...', 'saving')

      // 保存到 Supabase（复用现有 ID 或创建新 ID）
      const savedId = await saveToCloud(data, currentCloudId)

      if (savedId) {
        currentCloudId = savedId
        localStorage.setItem('mindmap-cloud-id', savedId)
        localStorage.setItem('mindmap-data', JSON.stringify(data))

        // 生成短链接
        const shareUrl = generateShareUrl(savedId)

        // 显示分享链接
        document.getElementById('share-url-display').value = shareUrl
        document.getElementById('save-modal').classList.remove('hidden')

        updateStatus(`已保存到云端 (ID: ${savedId})`, 'saved')
      } else {
        showToast('保存失败，请重试')
        updateStatus('保存失败', '')
      }
    })

    // 复制链接
    document.getElementById('btn-copy-url').addEventListener('click', () => {
      const textarea = document.getElementById('share-url-display')
      textarea.select()

      navigator.clipboard.writeText(textarea.value).then(() => {
        showToast('链接已复制，可在任意设备打开')
      }).catch(() => {
        document.execCommand('copy')
        showToast('链接已复制')
      })
    })

    // 关闭保存弹窗
    document.getElementById('btn-close-save-modal').addEventListener('click', () => {
      document.getElementById('save-modal').classList.add('hidden')
    })

    // 打开导入弹窗
    document.getElementById('btn-load-cloud').addEventListener('click', () => {
      document.getElementById('load-data-input').value = ''
      document.getElementById('load-modal').classList.remove('hidden')
      document.getElementById('load-data-input').focus()
    })

    // 取消导入
    document.getElementById('btn-cancel-load').addEventListener('click', () => {
      document.getElementById('load-modal').classList.add('hidden')
    })

    // 确认导入
    document.getElementById('btn-confirm-load').addEventListener('click', async () => {
      const input = document.getElementById('load-data-input').value

      if (!input.trim()) {
        showToast('请粘贴链接、ID 或 JSON 数据')
        return
      }

      const parsed = parseUserInput(input)

      if (!parsed) {
        showToast('无法识别的数据格式')
        return
      }

      // 如果是云端 ID，需要异步加载
      if (parsed.cloudId) {
        showToast('正在从云端加载...')
        const cloudData = await loadFromCloud(parsed.cloudId)
        if (cloudData) {
          mind.refresh(cloudData)
          currentCloudId = parsed.cloudId
          localStorage.setItem('mindmap-data', JSON.stringify(cloudData))
          localStorage.setItem('mindmap-cloud-id', parsed.cloudId)
          document.getElementById('load-modal').classList.add('hidden')
          showToast('导入成功')
          updateStatus(`已加载云端数据 (ID: ${parsed.cloudId})`, 'saved')
        } else {
          showToast('云端数据加载失败，请检查 ID 是否正确')
        }
        return
      }

      // 直接使用 JSON 数据
      if (parsed.mindmapData) {
        mind.refresh(parsed.mindmapData)
        currentCloudId = null
        localStorage.setItem('mindmap-data', JSON.stringify(parsed.mindmapData))
        localStorage.removeItem('mindmap-cloud-id')
        document.getElementById('load-modal').classList.add('hidden')
        showToast('导入成功')
        updateStatus('已导入本地数据', 'saved')
      }
    })

    // 点击遮罩关闭弹窗
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.classList.add('hidden')
        }
      })
    })

    document.getElementById('btn-export-png').addEventListener('click', async () => {
      try {
        const blob = await mind.exportPng()
        if (!blob) {
          showToast('导出失败，请重试')
          return
        }
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = 'mindmap.png'
        a.click()
        URL.revokeObjectURL(url)
        showToast('导出成功')
      } catch (e) {
        console.error('导出PNG失败', e)
        showToast('导出失败: ' + e.message)
      }
    })

    document.getElementById('btn-export-json').addEventListener('click', () => {
      const data = mind.getData()
      const json = JSON.stringify(data, null, 2)
      const blob = new Blob([json], { type: 'application/json' })
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = 'mindmap.json'
      a.click()
      URL.revokeObjectURL(url)
      showToast('导出成功')
    })

    document.getElementById('btn-clear').addEventListener('click', () => {
      if (confirm('确定要清空所有内容吗？')) {
        const newData = MindElixir.new('新的思维导图')
        mind.init(newData)
        localStorage.removeItem('mindmap-data')
        localStorage.removeItem('mindmap-cloud-id')
        updateStatus('已清空', '')
      }
    })

    // 自动保存到 localStorage
    let saveTimeout = null
    mind.bus.addListener('operation', (operation) => {
      // 防抖：500ms 内只保存一次
      if (saveTimeout) clearTimeout(saveTimeout)

      updateStatus('正在保存...', 'saving')

      saveTimeout = setTimeout(() => {
        localStorage.setItem('mindmap-data', JSON.stringify(mind.getData()))
        updateStatus('已自动保存', 'saved')
      }, 500)
    })
  </script>
</body>
</html>
